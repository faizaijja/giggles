{% load static %}
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <!-- Include Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- Include jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>


    <link href="{% static 'css/giggles.css' %}" rel="stylesheet" />
    <title>Giggles - Progress</title>
    <style>
      /* Base styles matching the existing theme */
      :root {
        --primary-color: #7c4dff;
        --secondary-color: #ff5c8d;
        --gradient-start: #7c4dff;
        --gradient-end: #ff5c8d;
        --background-color: #f5f7fb;
        --card-bg: #ffffff;
        --text-primary: #333333;
        --text-secondary: #6c757d;
        --success-color: #4caf50;
        --warning-color: #ff9800;
        --danger-color: #f44336;
        --info-color: #2196f3;
        --shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        --border-radius: 12px;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Poppins", sans-serif;
      }

      body {
        background-color: var(--background-color);
        color: var(--text-primary);
      }

      /* Main content styles */
      .content {
        margin-left: 260px;
        padding: 80px 30px 0;
        min-height: 100vh;
        position: relative;
      }

      .main-content {
        padding-bottom: 60px;
        max-width: 1200px;
        margin: 0 auto;
      }

      .progress-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
      }
      .charts-section {
            margin: 40px 0;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .chart-card {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .chart-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 45px rgba(0, 0, 0, 0.15);
        }

        .chart-card h3 {
            color: #2d3436;
            margin-bottom: 20px;
            font-size: 1.5rem;
            font-weight: 600;
            text-align: center;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .donut-chart {
        width: 200px;
        height: 200px;
        margin: 0 auto;
      }
        .chart-container {
            position: relative;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pie-chart-container {
            position: relative;
            height: 250px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        

      .gradient-text {
        background: linear-gradient(
          to right,
          var(--gradient-start),
          var(--gradient-end)
        );
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        font-weight: 700;
      }

      /* Progress summary section */
      .progress-summary {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 30px;
      }

      .summary-card {
        background: var(--card-bg);
        border-radius: var(--border-radius);
        padding: 20px;
        box-shadow: var(--shadow);
        transition: transform 0.3s ease;
      }

      .summary-card:hover {
        transform: translateY(-5px);
      }

      .summary-card .icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 15px;
      }

      .summary-card h3 {
        font-size: 1.8rem;
        margin-bottom: 5px;
      }

      .summary-card p {
        color: var(--text-secondary);
        font-size: 0.9rem;
      }

      .summary-card.completed .icon {
        background: rgba(76, 175, 80, 0.2);
        color: var(--success-color);
      }

      .summary-card.pending .icon {
        background: rgba(255, 152, 0, 0.2);
        color: var(--warning-color);
      }

      .summary-card.streak .icon {
        background: rgba(33, 150, 243, 0.2);
        color: var(--info-color);
      }

      .summary-card.points .icon {
        background: rgba(124, 77, 255, 0.2);
        color: var(--primary-color);
      }

      /* Time period selector */
      .time-period-selector {
        display: flex;
        background: var(--card-bg);
        border-radius: 30px;
        padding: 5px;
        box-shadow: var(--shadow);
        margin-bottom: 30px;
        width: fit-content;
      }

      .time-period-selector button {
        border: none;
        background: none;
        padding: 10px 20px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        color: var(--text-secondary);
      }

      .time-period-selector button.active {
        background: linear-gradient(
          to right,
          var(--gradient-start),
          var(--gradient-end)
        );
        color: white;
      }

      .progress-summary {
    display: flex;
    font-size: 1.1rem;
    margin-bottom: 1em;
    color: #333;
  }

  .progress-list {
    list-style: none;
    padding: 0;
  }

  .progress-item {
    background: #f9f9f9;
    padding: 1em;
    border-radius: 8px;
    border-left: 4px solid #667eea;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    margin-bottom: 1em;
    line-height: 1.6;
  }

  .progress-item strong {
    color: #444;
  }
  .no-progress {
    color: #e53e3e;
    font-weight: bold;
    padding: 1em;
    background-color: #fff5f5;
    border: 1px solid #f56565;
    border-radius: 5px;
  }

      /* Progress charts section */
      .progress-charts {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
      }

      .chart-card {
        background: var(--card-bg);
        border-radius: var(--border-radius);
        padding: 20px;
        box-shadow: var(--shadow);
      }

      .chart-card h3 {
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .chart-container {
        height: 300px;
        position: relative;
      }

      /* Subject progress section */
      .subject-progress {
        margin-bottom: 30px;
      }

      .subject-card {
        background: var(--card-bg);
        border-radius: var(--border-radius);
        padding: 20px;
        box-shadow: var(--shadow);
        margin-bottom: 20px;
      }

      .subject-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .subject-header h3 {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .subject-icon {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
      }

      .mathematics .subject-icon {
        background: rgba(124, 77, 255, 0.2);
        color: var(--primary-color);
      }

      .science .subject-icon {
        background: rgba(33, 150, 243, 0.2);
        color: var(--info-color);
      }

      .english .subject-icon {
        background: rgba(255, 92, 141, 0.2);
        color: var(--secondary-color);
      }

      .progress-bar {
        height: 10px;
        background: #e9ecef;
        border-radius: 10px;
        margin-bottom: 10px;
        overflow: hidden;
      }

      .progress-bar .fill {
        height: 100%;
        border-radius: 10px;
        transition: width 1s ease;
      }

      .mathematics .fill {
        background: linear-gradient(to right, #7c4dff, #9e7fff);
      }

      .science .fill {
        background: linear-gradient(to right, #2196f3, #64b5f6);
      }

      .english .fill {
        background: linear-gradient(to right, #ff5c8d, #ff8ab5);
      }

      .progress-details {
        display: flex;
        justify-content: space-between;
        color: var(--text-secondary);
        font-size: 0.85rem;
      }

      /* Recent activities section */
      .recent-activities {
        background: var(--card-bg);
        border-radius: var(--border-radius);
        padding: 20px;
        box-shadow: var(--shadow);
      }

      .activity-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .activity-list {
        max-height: 400px;
        overflow-y: auto;
      }

      .activity-item {
        display: flex;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid #f0f0f0;
      }

      .activity-item:last-child {
        border-bottom: none;
      }

      .activity-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        flex-shrink: 0;
      }

      .activity-completed {
        background: rgba(76, 175, 80, 0.2);
        color: var(--success-color);
      }

      .activity-quiz {
        background: rgba(255, 152, 0, 0.2);
        color: var(--warning-color);
      }

      .activity-content {
        flex-grow: 1;
      }

      .activity-title {
        font-weight: 600;
        margin-bottom: 3px;
      }

      .activity-time {
        font-size: 0.8rem;
        color: var(--text-secondary);
      }

      .activity-score {
        background: linear-gradient(
          to right,
          var(--gradient-start),
          var(--gradient-end)
        );
        color: white;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
      }

      /* Download report button */
      .download-report {
        margin-top: 20px;
        background: linear-gradient(
          to right,
          var(--gradient-start),
          var(--gradient-end)
        );
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        box-shadow: 0 4px 15px rgba(124, 77, 255, 0.3);
      }

      .download-report:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(124, 77, 255, 0.4);
      }

      /* Badges section */
      .badges-section {
        margin-top: 30px;
      }

      .badges-container {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 20px;
      }

      .badge-card {
        background: var(--card-bg);
        border-radius: var(--border-radius);
        padding: 20px;
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        transition: transform 0.3s ease;
        position: relative;
      }

      .badge-card:hover {
        transform: translateY(-5px);
      }

      .badge-icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        position: relative;
      }

      .badge-locked {
        opacity: 0.5;
      }

      .badge-locked::before {
        content: "üîí";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.5rem;
        z-index: 2;
      }

      .badge-1 .badge-icon {
        background: linear-gradient(to right bottom, #ffd700, #ffa500);
        color: white;
      }

      .badge-2 .badge-icon {
        background: linear-gradient(to right bottom, #7c4dff, #3f51b5);
        color: white;
      }

      .badge-3 .badge-icon {
        background: linear-gradient(to right bottom, #ff5c8d, #ff0844);
        color: white;
      }

      .badge-4 .badge-icon {
        background: linear-gradient(to right bottom, #4caf50, #8bc34a);
        color: white;
      }

      .badge-5 .badge-icon {
        background: linear-gradient(to right bottom, #2196f3, #03a9f4);
        color: white;
      }

      .badge-name {
        font-weight: 600;
        margin-bottom: 5px;
      }

      .badge-desc {
        font-size: 0.8rem;
        color: var(--text-secondary);
      }

      /* Responsive styles */
      @media (max-width: 1200px) {
        .progress-summary {
          grid-template-columns: repeat(2, 1fr);
        }

        .progress-charts {
          grid-template-columns: 1fr;
        }

        .badges-container {
          grid-template-columns: repeat(3, 1fr);
        }
      }

      @media (max-width: 768px) {
        .content {
          margin-left: 0;
          padding: 80px 15px 0;
        }

        .progress-summary {
          grid-template-columns: 1fr;
        }

        .badges-container {
          grid-template-columns: repeat(2, 1fr);
        }
      }
    </style>
  </head>
  <body>
    <div class="sidebar">
      <div class="logo-container">
        <a class="logo" href="#">
          <div class="logo-icon">
            <img
              alt="Giggles Logo"
              src="{% static 'images/Giggles logo.png' %}"
            />
          </div>
          <div class="logo-text">Giggles<span></span></div>
        </a>
      </div>
      <nav class="nav-menu">
        <ul class="nav-list">
          <li class="nav-item">
            <a class="nav-link" href="{% url 'index' %}">
              <div class="nav-icon">
                <svg viewbox="0 0 24 24">
                  <path
                    d="M3 9L12 2L21 9V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V9Z"
                  ></path>
                  <path d="M9 22V12H15V22"></path>
                </svg>
              </div>
              <span>Dashboard</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{% url 'lessons' %}">
              <div class="nav-icon">
                <svg viewbox="0 0 24 24">
                  <path
                    d="M2 3H8C9.06087 3 10.0783 3.42143 10.8284 4.17157C11.5786 4.92172 12 5.93913 12 7V21C12 20.2044 11.6839 19.4413 11.1213 18.8787C10.5587 18.3161 9.79565 18 9 18H2V3Z"
                  ></path>
                  <path
                    d="M22 3H16C14.9391 3 13.9217 3.42143 13.1716 4.17157C12.4214 4.92172 12 5.93913 12 7V21C12 20.2044 12.3161 19.4413 12.8787 18.8787C13.4413 18.3161 14.2044 18 15 18H22V3Z"
                  ></path>
                </svg>
              </div>
              <span>Lessons</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{% url 'socials' %}">
              <div class="nav-icon">
                <svg viewbox="0 0 24 24">
                  <path
                    d="M17 21V19C17 17.9391 16.5786 16.9217 15.8284 16.1716C15.0783 15.4214 14.0609 15 13 15H5C3.93913 15 2.92172 15.4214 2.17157 16.1716C1.42143 16.9217 1 17.9391 1 19V21"
                  ></path>
                  <path
                    d="M9 11C11.2091 11 13 9.20914 13 7C13 4.79086 11.2091 3 9 3C6.79086 3 5 4.79086 5 7C5 9.20914 6.79086 11 9 11Z"
                  ></path>
                  <path
                    d="M23 21V19C22.9993 18.1137 22.7044 17.2528 22.1614 16.5523C21.6184 15.8519 20.8581 15.3516 20 15.13"
                  ></path>
                  <path
                    d="M16 3.13C16.8604 3.35031 17.623 3.85071 18.1676 4.55232C18.7122 5.25392 19.0078 6.11683 19.0078 7.005C19.0078 7.89318 18.7122 8.75608 18.1676 9.45769C17.623 10.1593 16.8604 10.6597 16 10.88"
                  ></path>
                </svg>
              </div>
              <span>Social Skills</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="{% url 'learning:progress' %}">
              <div class="nav-icon">
                <svg viewbox="0 0 24 24">
                  <line x1="18" x2="18" y1="20" y2="10"></line>
                  <line x1="12" x2="12" y1="20" y2="4"></line>
                  <line x1="6" x2="6" y1="20" y2="14"></line>
                  <path d="M3 20H21"></path>
                </svg>
              </div>
              <span>Progress</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{% url 'settings' %}">
              <div class="nav-icon">
                <svg viewbox="0 0 24 24">
                  <path
                    d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z"
                  ></path>
                  <path
                    d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
                  ></path>
                </svg>
              </div>
              <span>Settings</span>
            </a>
          </li>
        </ul>
      </nav>
        <div id="timerDisplay"></div>
<script src="{% static 'js/timer.js' %}"></script>
    </div>
    <div class="content">
      <div class="main-content">
        <div class="progress-header">
          <h1 class="gradient-text">My Learning Progress</h1>
         <button class="download-report" id="download-report">

  <svg
    fill="none"
    height="20"
    stroke="currentColor"
    stroke-linecap="round"
    stroke-linejoin="round"
    stroke-width="2"
    viewBox="0 0 24 24"
    width="20"
    xmlns="http://www.w3.org/2000/svg"
  >
    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
    <polyline points="7 10 12 15 17 10"></polyline>
    <line x1="12" x2="12" y1="15" y2="3"></line>
  </svg>
  Download Progress Report
</button>

        </div>

        
        <div class="progress-summary">
          <div class="summary-card completed">
            <div class="icon">
              <svg
                fill="none"
                height="24"
                stroke="currentColor"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                viewbox="0 0 24 24"
                width="24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
              </svg>
            </div>
            
          
            <div class="badge-name">First Steps</div>
              <div class="badge-desc">Complete your first lesson</div>
          </div>
          <div class="summary-card pending">
            <div class="icon">
              <svg
                fill="none"
                height="24"
                stroke="currentColor"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                viewbox="0 0 24 24"
                width="24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
            </div>
             <div class="badge-name">Knowledge Seeker</div>
              <div class="badge-desc">Complete 5 lessons in any subject</div>
          </div>
          <div class="summary-card streak">
            <div class="icon">
              <svg
                fill="none"
                height="24"
                stroke="currentColor"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                viewbox="0 0 24 24"
                width="24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"
                ></path>
              </svg>
            </div>
            <div class="badge-name">Perfect Score</div>
              <div class="badge-desc">Get 100% on any assessment</div>
          </div>
          <div class="summary-card points">
            <div class="icon">
              <svg
                fill="none"
                height="24"
                stroke="currentColor"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                viewbox="0 0 24 24"
                width="24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <polygon
                  points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"
                ></polygon>
              </svg>
            </div>
           <div class="badge-name">Super Scholar</div>
              <div class="badge-desc">Complete 10 courses</div>
          </div>
        </div>
        <div class="badges-section">
          <h2 class="gradient-text" style="margin-bottom: 20px">
           
        </div>
        <div class="time-period-selector">
          <button class="period-btn" data-period="weekly">Weekly</button>
        </div>


        <!-- templates/learning/progress.html -->



        <div class="progress-charts">
          <div class="chart-card">
            <h3>
              Learning Progress
              <span
                style="
                  font-size: 0.8rem;
                  color: var(--text-secondary);
                  font-weight: normal;
                "
                >{{ current_month|default:"Recent Activity" }}</span
              >
            </h3>
            <div class="chart-container">
              <canvas id="progressChart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <h3>Course Distribution</h3>
            <div class="chart-container">
              <canvas id="donutChart" width="400" height="400"></canvas>
            </div>
          </div>
        </div>
        <!-- Course Progress Section -->
        <div class="subject-progress">
          <h2 class="gradient-text" style="margin-bottom: 20px">
            Progress Report for {{ user.get_full_name }} 
          </h2>

          {% for lesson in student_progress %}
          <div class="subject-card" data-course-id="{{ course.id }}">
            <div class="subject-header">
              <h3>
                <div class="subject-icon">{{ course.icon|default:"üìö" }}</div>
                <a
                  href="{% url 'learning:course_detail' course.slug %}"
                  style="color: inherit; text-decoration: none"
                >
                  {{ lesson.title }}
                </a>
              </h3>
              <span class="completion-percentage"
                >{{ lesson.completion_percentage|floatformat:1 }}%</span
              >
            </div>
            <div class="progress-bar">
              <div
                class="progress-bar"
                data-completion="{{ course.completion_percentage|floatformat:0 }}"
              >
                <div class="fill"></div>
              </div>
            </div>
            <div class="progress-details">
              <span
                >Completed: {{ progress.completed_lessons }}/{{
                progress.total_lessons }}</span
              >
              <span>In Progress: {{ progress.in_progress_lessons }}</span>
              <span
                >Best Score: {% if progress.best_score %}{{
                progress.best_score|floatformat:1 }}%{% else %}-{% endif %}</span
              >
              <span
                >Assessments: {{ progress.completed_assessments }}/{{
                progress.total_assessments }}</span
              >
            </div>
            <div class="course-actions" style="margin-top: 10px">
              <a
                class="btn-small"
                href="{% url 'learning:course_detail' course.slug %}"
                >View Course</a
              >
              <a
                class="btn-small"
                href="{% url 'learning:course_progress_detail' course.slug %}"
                >Detailed Progress</a
              >
            </div>
          </div>
          {% empty %}
         
          {% endfor %}
        </div>

<p class="progress-summary"><strong>Progress records found: {{ progress_list|length }}</strong></p>

{% if progress_list %}
  <ul class="progress-list">
    {% for progress in progress_list %}
      <li style="margin-bottom: 1em;">
        <strong>Lesson:</strong> {{ progress.lesson.name }} <br>
        <strong>Status:</strong> {{ progress.get_status_display }} <br>
        <strong>Score:</strong> {{ progress.score }} <br>
        <strong>Attempts:</strong> {{ progress.attempts }} <br>
        <strong>Started At:</strong> {{ progress.started_at|default:"-" }} <br>
        <strong>Completed At:</strong> {{ progress.completed_at|default:"-" }}
      </li>
    {% endfor %}
  </ul>
{% else %}
  <p style="color: red;">No progress records to show for this student.</p>
{% endif %}

  
</div>

        <!-- Recent Lesson Progress -->
       {% if recent_lessons %}
<div class="lesson-progress">
  <h2 class="gradient-text" style="margin-bottom: 20px">
    Recent Lesson Progress
  </h2>

  {% for lesson in recent_lessons %}
  <div class="subject-card">
    <div class="subject-header">
      <h3>
        <div class="subject-icon">üìò</div>
        <a
          href="{% url 'learning:lesson_detail' lesson.course.slug lesson.slug %}"
          style="color: inherit; text-decoration: none"
        >
          {{ lesson.title }}
        </a>
      </h3>
      <span class="completion-percentage">
        {% if lesson.is_completed %}‚úÖ Completed 
        {% elif lesson.is_started %}‚è≥ In Progress 
        {% else %}üìã Not Started
        {% endif %}
      </span>
    </div>

    <div class="progress-bar" data-completion="{% if lesson.is_completed %}100{% elif lesson.is_started %}50{% else %}0{% endif %}">
      <div class="fill"></div>
    </div>

    <div class="progress-details">
      <span>Course: {{ lesson.course.title }}</span>
      <span>
        Status: {% if lesson.is_completed %}Completed
        {% elif lesson.is_started %}In Progress
        {% else %}Not Started
        {% endif %}
      </span>
      <span>Last Updated: {{ lesson.updated_at|date:"M d, Y" }}</span>
      {% if lesson.duration %}
      <span>Duration: {{ lesson.duration }} min</span>
      {% endif %}
    </div>

    <div class="lesson-actions" style="margin-top: 10px">
      {% if lesson.is_completed %}
        <a href="{% url 'learning:lesson_detail' lesson.course.slug lesson.slug %}" class="btn-small">Review Lesson</a>
      {% elif lesson.is_started %}
        <a href="{% url 'learning:lesson_detail' lesson.course.slug lesson.slug %}" class="btn-small">Continue</a>
      {% else %}
        <a href="{% url 'learning:start_lesson' lesson.course.slug lesson.slug %}" class="btn-small">Start Lesson</a>
      {% endif %}
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}

<div class="card">
    <div
      class="progress-bar"
      data-completion="{{ course_progress.average_score|floatformat:0 }}"
    >

            <!-- Recent Assessment Results -->
            {% if recent_assessments %}
            <div class="recent-activities">
              <div class="activity-header">
                <h3 class="gradient-text">Recent Assessment Results</h3>
              </div>
              <div class="activity-list">
                {% for assessment in recent_assessments %}
                <div class="activity-item">
                  <div class="activity-icon activity-quiz">üìù</div>
                  <div class="activity-content">
                    <div class="activity-title">
                      <a
                        href="{% url 'learning:assessment_result' assessment.course.slug assessment.id %}"
                        style="color: inherit; text-decoration: none"
                      >
                        {{ assessment.course.title }} - {{ assessment.title }}
                      </a>
                    </div>
                    {% if assessments %} {% for assessment in assessments %}
                    <div class="assessment-result">
                      {{ assessment.completed_at|date:"M d, Y H:i" }} - Score:
                      {{ assessment.score }}/{{ assessment.total_questions }}
                      ({{ assessment.percentage|floatformat:1 }}%) 
                      {% if assessment.passed %} ‚úÖ Passed 
                      {% else %} ‚ùå Retry 
                      {% endif %}
                    </div>
                    {% endfor %} {% else %}
                    <p>No assessments found.</p>
                    {% endif %}
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
            {% endif %}
          </div>
          <!--------------header------------->
          <div class="header">
            <div class="search-container"></div>
            <div class="header-actions">
            
              <div class="user-profile">
                <div class="avatar">
                  <span class="avatar-initial"
                    >{{ user.first_name.0|upper|default:"U" }}</span
                  >
                </div>
                <div class="user-info">
                  <span class="user-name"
                    >{{ user.get_full_name|default:user.username }}</span
                  >
                  <span class="user-role">Student</span>
                </div>

              <p><a href="{% url 'logout' %}">Logout</a></p>
                
              </div>
            </div>
          </div>
          <script id="report-data" type="application/json">
            {
                "student_name": "{{ user.get_full_name|default:user.username }}",
                "completed_lessons": {{ progress_summary.completed_lessons|default:0 }},
                "in_progress_lessons": {{ progress_summary.in_progress_lessons|default:0 }},
                "total_assessments": {{ progress_summary.total_assessments|default:0 }},
                "courses": [
                    {% for course in course_progress %}
                    {
                        "name": "{{ course.title }}",
                        "completion": {{ course.completion_percentage|floatformat:0 }},
                        "lessons_completed": {{ course.completed_lessons }},
                        "total_lessons": {{ course.total_lessons }}
                    }{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],
                "recent_activities": [
                    {% for assessment in recent_assessments|slice:":5" %}
                    {
                        "title": "{{ assessment.course.title }} - {{ assessment.title }}",
                        "score": "{{ assessment.score }}",
                        "total": "{{ assessment.total_questions }}",
                        "percentage": "{{ assessment.percentage|floatformat:1 }}%",
                        "date": "{{ assessment.completed_at|date:'M d, Y' }}"
                    }{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ]
            }
          </script>
          
          <script>
            

(function () {
  "use strict";

  const CHART_CONFIG = {
    colors: {
      primary: "#7c4dff",
      secondary: "#ff5c8d",
      blue: "#2196f3",
      green: "#4caf50",
      orange: "#ff9800",
      pink: "#e91e63",
    },
  };
  

  function getReportData() {
    try {
      const reportElement = document.getElementById("report-data");
      return JSON.parse(reportElement.textContent);
    } catch (error) {
      console.error("Error parsing report data:", error);
      return null;
    }
  }

  function generateProgressReport() {
    console.log("Download button clicked"); // Confirm click works

    if (!window.jspdf || !window.jspdf.jsPDF) {
      alert("jsPDF library not loaded");
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const reportData = getReportData();
    if (!reportData) return;

    doc.setFontSize(20);
    doc.setTextColor(124, 77, 255);
    doc.text("Learning Progress Report", 20, 30);

    doc.setFontSize(14);
    doc.setTextColor(0, 0, 0);
    doc.text(`Student: ${reportData.student_name}`, 20, 50);
    doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 65);

    doc.setFontSize(16);
    doc.text("Summary", 20, 90);
    doc.setFontSize(12);
    doc.text(`‚Ä¢ Completed Lessons: ${reportData.completed_lessons}`, 25, 105);
    doc.text(`‚Ä¢ In Progress: ${reportData.in_progress_lessons}`, 25, 120);
    doc.text(`‚Ä¢ Total Assessments: ${reportData.total_assessments}`, 25, 135);

    let y = 160;
    doc.setFontSize(16);
    doc.text("Courses", 20, y);
    y += 15;
    doc.setFontSize(12);
    for (const course of reportData.courses) {
      if (y > 270) { doc.addPage(); y = 30; }
      doc.text(`${course.name}:`, 25, y);
      doc.text(`${course.completion}% (${course.lessons_completed}/${course.total_lessons})`, 35, y + 10);
      y += 25;
    }

    if (reportData.recent_activities?.length) {
      if (y > 200) { doc.addPage(); y = 30; }
      doc.setFontSize(16);
      doc.text("Recent Assessments", 20, y);
      y += 20;
      doc.setFontSize(12);
      for (const act of reportData.recent_activities) {
        if (y > 270) { doc.addPage(); y = 30; }
        doc.text(`‚Ä¢ ${act.title}`, 25, y);
        doc.text(`  Score: ${act.score}/${act.total} (${act.percentage}) - ${act.date}`, 30, y + 10);
        y += 25;
      }
    }

    doc.save(`${reportData.student_name.replace(/\s+/g, "_")}_Progress_Report.pdf`);
  }

  function initializeReportDownload() {
    const btn = document.getElementById("download-report");
    if (!btn) {
      console.warn("Download button not found");
      return;
    }
    btn.addEventListener("click", generateProgressReport);
  }

  function initializeCharts() {
    const ctxLine = document.getElementById("progressChart")?.getContext("2d");
    const data = getReportData();
    if (!ctxLine || !data) return;

    const labels = data.courses.map(c => c.name);
    const completions = data.courses.map(c => c.completion);
    const lessons = data.courses.map(c => c.lessons_completed);

    const progressCtx = document
        .getElementById("progressChart")
        .getContext("2d");
      const progressChart = new Chart(progressCtx, {
        type: "line",
        data: {
          labels: ["Monday", "Tuesday", "Wednesday", "Thursday","Friday"],
          datasets: [
            {
              label: "Hours Spent",
              data: [5, 8, 6, 9, 7],
              borderColor: "#667eea",
              backgroundColor: "rgba(102, 126, 234, 0.1)",
              tension: 0.4,
              fill: true,
            },
            {
              label: "Lessons Completed",
              data: [3, 7, 5, 9, 6],
              borderColor: "#ff6384",
              backgroundColor: "rgba(255, 99, 132, 0.1)",
              tension: 0.4,
              fill: true,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: "top",
            },
          },
          scales: {
            y: {
              beginAtZero: true,
            },
          },
        },
      });
      // Create donut chart
      const donutCanvas = document.getElementById("donutChart");
  if (!donutCanvas) return;

  const donutCtx = donutCanvas.getContext("2d");

  const donutChart = new Chart(donutCtx, {
    type: "doughnut",
    data: {
      labels: ["Mathematics", "Science", "Social Studies", "Literacy", "Arts", "Culture"],
      datasets: [
        {
          data: [16.67, 16.67, 16.67, 16.67, 16.67, 16.67],
          backgroundColor: ["#667eea", "#36a2eb", "#ff6384", "pink", "purple", "green"],
          borderWidth: 0,
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          position: "bottom",
        },
      },
    },
  });

  }

  document.addEventListener("DOMContentLoaded", () => {
    initializeCharts();
    initializeReportDownload();
  });
})();


          </script>
          <script>
  document.getElementById("download-report").addEventListener("click", function () {
    window.location.href = "{% url 'progress_pdf' %}";
  });
</script>
        </div>
      </div>
    </div>
  </body>
</html>
